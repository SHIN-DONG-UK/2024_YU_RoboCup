# 🏁 라인트레이싱(Line Tracing)
## 문서 개요
#### 1. 적외선 센서와 라인 위치 추정
#### 2. 무게중심 원리
#### 3. 피크 위치 보정 및 계산
#### 4. PID 제어기 설계 및 적용

<br>

### 1. 적외선 센서 : 라인 위치 어림잡기
> *4개의 센서 데이터를 바탕으로 라인의 상대 위치를 추정하는 방법을 설명합니다.*

![alt text](/data/4/4_1.png)

- 로봇이 바닥 라인을 따라 주행하기 위해서는, `바닥 라인이 로봇에 대해 어디 있는가?`하는 수치 데이터가 필요함

- 마이크로 마우스는 6개의 적외선 센서를 가지며, 이 중 가운데 4개를 사용해 라인 위치를 계산함

- 센서 출력 특성
    - 검은색 라인 : 센서값 높음
    - 흰색 라인 : 센서값 낮음

### 2. 무게중심(Center of mess) 원리
> *여러 센서값의 분포를 하나의 위치 값으로 압축하는 무게중심 공식을 소개합니다.*

![alt text](/data/4/4_2.png)

- 무게 중심은 여러 질점의 전체 질량이 작용하는 균형점

- 각 센서값을 질량에 대응시켜, 계산된 균형점이 라인 중심 위치가 됨

<br>

### 3. 피크 위치 보정 및 계산
> *실제 센서값(딥 분포)을 peak 형태로 변환하고 위치를 계산하는 과정을 설명합니다.*


![alt text](/data/4/4_3.png)

- 무게 중심 공식을 이용해 간단하지만 비교적 정확한 `피크 위치`를 찾을 수 있다

- 4개의 센서값으로 적당히 계산해서, 라인 중심이 어느 위치에 있는지를 어림잡는 것

<br>

![alt text](/data/4/4_4.png)

- 적외선 센서는 검은색 라인이 감지되면 높은 값, 흰색 라인이 감지되면 낮은 값을 출력

- 그래서 실제로는 `peak 분포`가 아니라, `dip 분포`이다

- `peak 형태`로 바꾸기 위해 

    $보정된 값 = 1023 - offset 값 - 측정값$

    을 사용

<br>

### 4. PID 제어기 설계 및 적용

> *라인 위치 오차를 0으로 만들기 위한 PID 제어기 구조와 흐름을 설명합니다.*

```csharp
[1] 센서 → 무게중심 계산 → R_cm
                         ↓
                         e = R_cm – 2.5     (라인 위치 오차)
                         ↓
[2] ┌─────────── PID_line ──────────────────┐
    │    u_line = Kp·e + Ki·∫e + Kd·de/dt   │
    └───────────────────────────────────────┘
                         ↓
[3] 기준 속도 V와 율속도 차이 ΔV 생성  
     (예:  left_cmd  = V – u_line  
           right_cmd = V + u_line  )  
                         ↓
[4] 모터 속도 제어기 (내부에 Velocity PID)  
     → 실제 모터 토크/회전속도로 변환  
                         ↓
[5] 로봇이 움직여서 라인에 대해 위치가 바뀜  
                         ↓  
     다시 [1]번 센서로 피드백
```

- **입력** : 라인 위치 오차 $e$

- **출력** : pwm 신호

- **특이사항** : 다른 스케일의 입력을 시스템이 사용할 수 있는 스케일로의 변환도 수행함

- **블록 다이어그램**

```
[센서] → [무게중심 계산] → [PID_line] → [속도 보정] → [모터 속도 제어] → [로봇 이동]
    ↑                                                                   ↓
    └────────────────────────── 피드백 ──────────────────────────────────┘

```